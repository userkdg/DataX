<?xml version="1.0" encoding="utf-8"?>


<datax>
    <syncReportDataSet
            mapColumns="report_name,report_path,system_code,data_set_name,data_set_guid,connection_name,connection_url,template_sql,collect_time"
            targetTable="meta_data_report_snapshot_day" seq="1">
        <countCql>
            match (m:`model.finereport.jobTemplateEntity`)-->(`model.finereport.dataSetDirectoryEntity`)-->(s:`model.finereport.dataSetEntity`) return count(s) as total
        </countCql>
        <cql>
            match (m:`model.finereport.jobTemplateEntity`)-->(`model.finereport.dataSetDirectoryEntity`)-->(s:`model.finereport.dataSetEntity`)
            return m.moiName as report_name,m.reportPath as report_path,m.systemCode as system_code,s.moiName as data_set_name,s.guid as data_set_guid,
            s.dataSetConnectionName as connection_name,s.dbURL as connection_url,s.sql as template_sql,
            apoc.date.format(apoc.date.currentTimestamp() + 1000 * 60 * 60 * 8 ,'ms','yyyy-MM-dd 00:00:00') as collect_time
        </cql>
    </syncReportDataSet>
    <syncReport
            mapColumns="report_name,report_path,system_code,collect_time"
            targetTable="meta_data_report_snapshot_day" seq="1">
        <countCql>
            match (m:`model.finereport.jobTemplateEntity`) where not ((m)-->(:`model.finereport.dataSetDirectoryEntity`)-->(:`model.finereport.dataSetEntity`)) return count(m) as total
        </countCql>
        <cql>
            match (s:`model.finereport.jobTemplateEntity`) where not ((s)-->(:`model.finereport.dataSetDirectoryEntity`)-->(:`model.finereport.dataSetEntity`))
            return s.moiName as report_name,s.reportPath as report_path,s.systemCode as system_code,
            apoc.date.format(apoc.date.currentTimestamp() + 1000 * 60 * 60 * 8 ,'ms','yyyy-MM-dd 00:00:00') as collect_time
        </cql>
        <postSql>
            <sql comment="清除旧数据">
                delete from meta_data_report_snapshot_day where current_date > date_format(collect_time, '%Y-%m-%d')
            </sql>
        </postSql>
    </syncReport>

</datax>