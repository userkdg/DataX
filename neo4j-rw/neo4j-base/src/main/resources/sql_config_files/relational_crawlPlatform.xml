<?xml version="1.0" encoding="utf-8"?>

<sql>

    <getCrawlJobConf type="NODE" workName="同步爬虫作业" seq="1" nodeName="爬虫作业"
                     label="model.crawlPlatform.crawlJobConfEntity"
                     columns="jobId,moiName,comment,jobType,jobSchedule,isValid,moiCreateDate,moiUpdateDate,isDelete,browserType,validStartTime,validEndTime,isOnline,businessName,createUserId,platformName,platformGroupName,guid,updateDate">
        <![CDATA[

                SELECT
                    t1.job_id as jobId,
                    t1.job_name AS moiName,
                    t1.job_desc AS comment,
                    t1.job_type AS jobType,
                    t1.job_schedule AS jobSchedule,
                    t1.is_valid AS isValid,
                    DATE_FORMAT(t1.create_time,'%Y%m%d%H%i%s')  AS moiCreateDate,
                    DATE_FORMAT(t1.update_time,'%Y%m%d%H%i%s') AS moiUpdateDate,
                    t1.is_delete AS isDelete,
                    t1.browser_type AS browserType,
                    t1.valid_start_time AS validStartTime,
                    t1.valid_end_time AS validEndTime,
                    t1.is_online AS isOnline,
                    t5.business_name AS businessName,
                    t1.user_id AS createUserId,
                    t3.ch_name AS platformName,
                    t4.ch_name AS platformGroupName,
                    CONCAT('${param.systemId}',';','${param.env}',';','爬虫平台',';',t1.job_id) as guid,
                    DATE_FORMAT(t1.update_time,'%Y%m%d%H%i%s') AS updateTime
                FROM
                crawl_job_conf t1
                LEFT JOIN crawl_job_site t3 ON t1.site_id = t3.id AND t1.site_group_id = t3.group_id
                LEFT JOIN crawl_job_site_group t4 ON t3.group_id = t4.id
                LEFT JOIN crawl_business_line t5 ON t1.business_id = t5.business_id
                order by CONCAT('${param.systemId}',';','${param.env}',';','爬虫平台',';',t1.job_name)
		]]>
    </getCrawlJobConf>

    <getCrawlJobTableInfo type="NODE" workName="同步爬虫作业表" seq="2" nodeName="爬虫表"
                          label="model.crawlPlatform.crawlJobTableInfoEntity"
                          columns="tableId,moiName,crawlerDocumentName,storageType,businessName,moiCreateDate,moiUpdateDate,updateTime,guid">

        SELECT
        t2.id as tableId,
        t2.crawler_table AS moiName,
        t2.crawler_name AS crawlerDocumentName,
        t2.sink_type AS storageType,
        t5.business_name as businessName,
        DATE_FORMAT(t2.create_time,'%Y%m%d%H%i%s') AS moiCreateDate,
        DATE_FORMAT(t2.update_time,'%Y%m%d%H%i%s') AS moiUpdateDate,
        DATE_FORMAT(t2.update_time,'%Y%m%d%H%i%s') AS updateTime,
        CONCAT('${param.systemId}',';','${param.env}',';','爬虫平台',';',t1.job_id,';',t2.id) as
        guid
        FROM
        crawl_job_conf t1
        LEFT JOIN crawl_job_table_info t2 ON t1.job_id = t2.job_id
        LEFT JOIN crawl_job_site t3 ON t1.site_id = t3.id AND t1.site_group_id = t3.group_id
        LEFT JOIN crawl_job_site_group t4 ON t3.group_id = t4.id
        LEFT JOIN crawl_business_line t5 ON t2.business_id = t5.business_id
        where t2.crawler_name is not null

    </getCrawlJobTableInfo>






    <getCatalogToCrawlJobConfEntity type="RELATIONSHIP" workName="同步爬虫平台目录->爬虫作业" seq="3"
                                              label="model.bank.appDirectoryToCrawlJobConfEntity"
                                              srcLabel="resource.relational.catalogEntity"
                                              targetLabel="model.crawlPlatform.crawlJobConfEntity">
        SELECT
            CONCAT('${param.systemId}',';','${param.env}',';','爬虫平台') as sourceGuid,
            CONCAT('${param.systemId}',';','${param.env}',';','爬虫平台',';',t1.job_id) as targetGuid
        FROM
        crawl_job_conf t1
        LEFT JOIN crawl_job_site t3 ON t1.site_id = t3.id AND t1.site_group_id = t3.group_id
        LEFT JOIN crawl_job_site_group t4 ON t3.group_id = t4.id
        LEFT JOIN crawl_business_line t5 ON t1.business_id = t5.business_id
        order by CONCAT('${param.systemId}',';','${param.env}',';','爬虫平台',';',t1.job_name)
    </getCatalogToCrawlJobConfEntity>



    <getCrawlJobConfToCrawlJobTableInfoEntity type="RELATIONSHIP" workName="同步爬虫作业->爬虫表" seq="4"
                                      label="model.bank.crawlJobConfToCrawlJobTableInfoEntity"
                                      srcLabel="model.crawlPlatform.crawlJobConfEntity"
                                      targetLabel="model.crawlPlatform.crawlJobTableInfoEntity">
        SELECT
            CONCAT('${param.systemId}',';','${param.env}',';','爬虫平台',';',t1.job_id) as guid,
            CONCAT('${param.systemId}',';','${param.env}',';','爬虫平台',';',t1.job_id,';',t2.id) as guid
        FROM
        crawl_job_conf t1
        LEFT JOIN crawl_job_table_info t2 ON t1.job_id = t2.job_id
        LEFT JOIN crawl_job_site t3 ON t1.site_id = t3.id AND t1.site_group_id = t3.group_id
        LEFT JOIN crawl_job_site_group t4 ON t3.group_id = t4.id
        LEFT JOIN crawl_business_line t5 ON t2.business_id = t5.business_id
        where t2.crawler_name is not null
    </getCrawlJobConfToCrawlJobTableInfoEntity>


    <getCrawlJobTableInfoToTableEntity type="RELATIONSHIP" workName="同步爬虫表->Hbase表" seq="5"
                                              label="model.bank.crawlJobTableInfoToTableEntity"
                                              srcLabel="resource.relational.tableEntity"
                                              targetLabel="model.crawlPlatform.crawlJobTableInfoEntity"
                                              relationType="DRT.Dependency"
    >

        SELECT
        CONCAT('${param.hbaseSystemId}',';','${param.env}',';','HBase',';','${param.hbaseSchema}',';',CASE
        WHEN SUBSTRING_INDEX(t2.crawler_table, '.', 1) = t2.crawler_table THEN SUBSTRING_INDEX(t2.crawler_table, '.', 1)
        ELSE SUBSTRING_INDEX(SUBSTRING_INDEX(t2.crawler_table, '.', 2), '.', -1)
        END) as sourceGuid,
        CONCAT('${param.systemId}',';','${param.env}',';','爬虫平台',';',t1.job_id,';',t2.id) as
        targetGuid
        FROM
        crawl_job_conf t1
        LEFT JOIN crawl_job_table_info t2 ON t1.job_id = t2.job_id
        LEFT JOIN crawl_job_site t3 ON t1.site_id = t3.id AND t1.site_group_id = t3.group_id
        LEFT JOIN crawl_job_site_group t4 ON t3.group_id = t4.id
        LEFT JOIN crawl_business_line t5 ON t2.business_id = t5.business_id
        where t2.sink_type = 1
    </getCrawlJobTableInfoToTableEntity>

</sql>