<?xml version="1.0" encoding="utf-8"?>

<sql>

    <getTables type="NODE" workName="同步表" seq="1" nodeName="表" label="resource.relational.tableEntity" columns="moiName,comment,moiCreateDate,moiUpdateDate,guid,updateTime,tableRows,dataLength">
        <![CDATA[

            SELECT
                lower(t.TABLE_NAME)  AS moiName,
                t.COMMENTS AS comment,
                TO_VARCHAR (TO_TIMESTAMP(mct.CREATE_TIME), 'YYYYMMDDHH24MISS')  AS moiCreateDate,
                TO_VARCHAR (TO_TIMESTAMP(mct.MODIFY_TIME), 'YYYYMMDDHH24MISS')  AS moiUpdateDate,
                CONCAT('${param.systemId}',CONCAT(';',CONCAT('${param.env}',CONCAT(';',CONCAT('数据字典',CONCAT(';',CONCAT('${param.importName}',CONCAT(';',CONCAT(lower(t.SCHEMA_NAME),CONCAT(';',lower(t.TABLE_NAME))))))))))) AS guid ,
                TO_VARCHAR (TO_TIMESTAMP(mct.MODIFY_TIME), 'YYYYMMDDHH24MISS')  AS updateTime,
                mct.RECORD_COUNT AS tableRows,
                mct.MEMORY_SIZE_IN_TOTAL AS dataLength

            FROM
                SYS.TABLES t LEFT JOIN sys.M_CS_TABLES mct
                ON (t.SCHEMA_NAME  = mct.SCHEMA_NAME  AND t.TABLE_NAME  = mct.TABLE_NAME )
            WHERE lower(t.SCHEMA_NAME)  = '${param.schema}' order by  t.TABLE_NAME

		]]>
    </getTables>


    <getTableColumn type="NODE" workName="同步表字段" seq="2" nodeName="表字段" label="resource.relational.columnEntity" sourceLabel="resource.relational.tableEntity" columns="moiCreateDate,moiUpdateDate,moiName,columnId,moiSeq,isNullable,sqlSimpleType,length,precision,scale,comment,updateTime,guid">
        <![CDATA[
                SELECT
                      t2.moiCreateDate AS moiCreateDate,
                      t2.moiUpdateDate AS moiUpdateDate,
                      lower(t.COLUMN_NAME) AS moiName,
                      t.POSITION AS columnId,
                      t.POSITION AS moiSeq,
                      t.IS_NULLABLE AS isNullable,
                      t.DATA_TYPE_NAME AS sqlSimpleType,
                      t.LENGTH AS length,
                      t.LENGTH AS precision,
                      t.SCALE AS scale,
                      t.COMMENTS AS comment,
                      t2.updateTime AS updateTime,
                      concat(t2.guid,concat(';',t.COLUMN_NAME)) AS guid
                    FROM SYS.TABLE_COLUMNS t
                    LEFT JOIN (
                          SELECT
                                    lower(t.TABLE_NAME)  AS tableName ,
                                    lower(t.schema_name) AS schemaName,
                                    TO_VARCHAR (TO_TIMESTAMP(mct.CREATE_TIME), 'YYYYMMDDHH24MISS')  AS moiCreateDate,
                                    TO_VARCHAR (TO_TIMESTAMP(mct.MODIFY_TIME), 'YYYYMMDDHH24MISS')  AS moiUpdateDate,
                                    CONCAT('${param.systemId}',CONCAT(';',CONCAT('${param.env}',CONCAT(';',CONCAT('数据字典',CONCAT(';',CONCAT('${param.importName}',CONCAT(';',CONCAT(lower(t.SCHEMA_NAME),CONCAT(';',lower(t.TABLE_NAME))))))))))) AS guid ,
                                    TO_VARCHAR (TO_TIMESTAMP(mct.MODIFY_TIME), 'YYYYMMDDHH24MISS')  AS updateTime
                                FROM
                                    SYS.TABLES t LEFT JOIN sys.M_CS_TABLES mct
                                    ON (t.SCHEMA_NAME  = mct.SCHEMA_NAME  AND t.TABLE_NAME  = mct.TABLE_NAME )
                    ) t2 ON lower(t.TABLE_NAME)  = t2.tableName AND lower(t.SCHEMA_NAME)  = t2.schemaName
                    WHERE lower(t.SCHEMA_NAME) = '${param.schema}' order by concat(t2.guid,concat(';',t.COLUMN_NAME))

		]]>
    </getTableColumn>

    <getView type="NODE" workName="同步表视图" seq="3" nodeName="视图" label="resource.relational.viewEntity" columns="moiName,comment,moiCreateDate,guid">
        SELECT
        lower(VIEW_NAME) AS moiName,
            COMMENTS AS comment,
            TO_VARCHAR (TO_TIMESTAMP(v.CREATE_TIME), 'YYYYMMDDHH24MISS')  AS moiCreateDate,
            CONCAT('${param.systemId}',CONCAT(';',CONCAT('${param.env}',CONCAT(';',CONCAT('数据字典',CONCAT(';',CONCAT('${param.importName}',CONCAT(';',CONCAT(lower(v.SCHEMA_NAME),CONCAT(';',lower(v.VIEW_NAME))))))))))) AS guid
        FROM sys.VIEWS v
            where lower(v.schema_name) = '${param.schema}'  order by  VIEW_NAME
    </getView>

    <getSQLIndexes type="NODE" workName="同步表索引" seq="4" nodeName="索引" label="resource.relational.sQLIndexEntity" columns="moiName,type,moiCreateDate,guid">
        <![CDATA[
            SELECT
                lower(v.INDEX_NAME) AS moiName,
                v.INDEX_TYPE  AS type,
                TO_VARCHAR (TO_TIMESTAMP(v.CREATE_TIME), 'YYYYMMDDHH24MISS')  AS moiCreateDate,
                CONCAT('${param.systemId}',CONCAT(';',CONCAT('${param.env}',CONCAT(';',CONCAT('数据字典',CONCAT(';',CONCAT('${param.importName}',CONCAT(';',CONCAT(lower(v.SCHEMA_NAME),CONCAT(';',concat(lower(v.INDEX_NAME),concat('_',lower(v.table_name))))))))))))) AS guid
            FROM
                sys.INDEXES v
            where lower(v.schema_name) = '${param.schema}' order by v.INDEX_NAME
	    ]]>
    </getSQLIndexes>

    <getViewColumn type="NODE" workName="同步视图字段" seq="5" nodeName="视图字段" label="resource.relational.columnEntity" sourceLabel="resource.relational.viewEntity"  columns="moiName,columnId,moiSeq,isNullable,sqlSimpleType,length,precision,scale,comment,guid">

        SELECT
        lower(t.COLUMN_NAME) AS moiName,
            t.POSITION AS columnId,
            t.POSITION AS moiSeq,
            t.IS_NULLABLE AS isNullable,
            t.DATA_TYPE_NAME AS sqlSimpleType,
            t.LENGTH AS length,
            t.LENGTH AS precision,
            t.SCALE AS scale,
            t.COMMENTS AS comment,
            concat(t2.guid,concat(';',lower(t.COLUMN_NAME))) AS guid
        FROM SYS.VIEW_COLUMNS t
        LEFT JOIN (
            SELECT
        lower(SCHEMA_NAME) AS schemaName,
        lower(VIEW_NAME) AS moiName,
                COMMENTS AS comment,
                TO_VARCHAR (TO_TIMESTAMP(v.CREATE_TIME), 'YYYYMMDDHH24MISS')  AS moiCreateDate,
                CONCAT('${param.systemId}',CONCAT(';',CONCAT('${param.env}',CONCAT(';',CONCAT('数据字典',CONCAT(';',CONCAT('${param.importName}',CONCAT(';',CONCAT(lower(v.SCHEMA_NAME),CONCAT(';',lower(v.VIEW_NAME))))))))))) AS guid
            FROM sys.VIEWS v
        ) t2 ON lower(t.VIEW_NAME)  = t2.moiName AND lower(t.SCHEMA_NAME)  = t2.schemaName
        WHERE lower(t.SCHEMA_NAME) = '${param.schema}' order by concat(t2.guid,concat(';',t.COLUMN_NAME))

    </getViewColumn>




    <getSchemasToView type="RELATIONSHIP" workName="同步Schema->视图的关系" seq="6" label="resource.relational.schemaToViewEntity" srcLabel="resource.relational.schemaEntity" targetLabel="resource.relational.viewEntity">

        SELECT
            CONCAT('${param.systemId}',CONCAT(';',CONCAT('${param.env}',CONCAT(';',CONCAT('数据字典',CONCAT(';',CONCAT('${param.importName}',CONCAT(';',lower(v.SCHEMA_NAME))))))))) AS sourceGuid,
            CONCAT('${param.systemId}',CONCAT(';',CONCAT('${param.env}',CONCAT(';',CONCAT('数据字典',CONCAT(';',CONCAT('${param.importName}',CONCAT(';',CONCAT(lower(v.SCHEMA_NAME),CONCAT(';',lower(v.VIEW_NAME))))))))))) AS targetGuid
        FROM sys.VIEWS v
            where lower(v.schema_name) = '${param.schema}'



    </getSchemasToView>

    <getViewToColumn type="RELATIONSHIP" workName="同步视图->视图字段的关系" seq="7" label="resource.relational.viewToColumnEntity" srcLabel="resource.relational.viewEntity" targetLabel="resource.relational.columnEntity">
        SELECT
        t2.guid AS sourceGuid,
        concat(t2.guid,concat(';',lower(t.COLUMN_NAME))) AS targetGuid
        FROM SYS.VIEW_COLUMNS t
        LEFT JOIN (
        SELECT
        lower(SCHEMA_NAME) AS schemaName,
        lower(VIEW_NAME) AS moiName,
        COMMENTS AS comment,
        TO_VARCHAR (TO_TIMESTAMP(v.CREATE_TIME), 'YYYYMMDDHH24MISS')  AS moiCreateDate,
        CONCAT('${param.systemId}',CONCAT(';',CONCAT('${param.env}',CONCAT(';',CONCAT('数据字典',CONCAT(';',CONCAT('${param.importName}',CONCAT(';',CONCAT(lower(v.SCHEMA_NAME),CONCAT(';',lower(v.VIEW_NAME))))))))))) AS guid
        FROM sys.VIEWS v
        ) t2 ON lower(t.VIEW_NAME)  = t2.moiName AND lower(t.SCHEMA_NAME)  = t2.schemaName
        WHERE lower(t.SCHEMA_NAME) = '${param.schema}'


    </getViewToColumn>



    <getSchemasToTable type="RELATIONSHIP" workName="同步Schema->表的关系" seq="8"  label="resource.relational.schemaToTableEntity" srcLabel="resource.relational.schemaEntity" targetLabel="resource.relational.tableEntity" >


        SELECT
        CONCAT('${param.systemId}',CONCAT(';',CONCAT('${param.env}',CONCAT(';',CONCAT('数据字典',CONCAT(';',CONCAT('${param.importName}',CONCAT(';',lower(t.SCHEMA_NAME))))))))) AS sourceGuid ,
        CONCAT('${param.systemId}',CONCAT(';',CONCAT('${param.env}',CONCAT(';',CONCAT('数据字典',CONCAT(';',CONCAT('${param.importName}',CONCAT(';',CONCAT(lower(t.SCHEMA_NAME),CONCAT(';',lower(t.TABLE_NAME))))))))))) AS targetGuid

        FROM
        SYS.TABLES t LEFT JOIN sys.M_CS_TABLES mct
        ON (t.SCHEMA_NAME  = mct.SCHEMA_NAME  AND t.TABLE_NAME  = mct.TABLE_NAME )
        WHERE lower(t.SCHEMA_NAME)  = '${param.schema}'

    </getSchemasToTable>

    <getTableToColumn type="RELATIONSHIP" workName="同步表->字段的关系" seq="9" label="resource.relational.tableToColumnEntity" srcLabel="resource.relational.tableEntity" targetLabel="resource.relational.columnEntity" >
        SELECT
        t2.guid as sourceGuid,
        concat(t2.guid,concat(';',lower(t.COLUMN_NAME))) AS targetGuid
        FROM SYS.TABLE_COLUMNS t
        LEFT JOIN (
        SELECT
        lower(t.TABLE_NAME)  AS tableName ,
        lower(t.schema_name) AS schemaName,
        TO_VARCHAR (TO_TIMESTAMP(mct.CREATE_TIME), 'YYYYMMDDHH24MISS')  AS moiCreateDate,
        TO_VARCHAR (TO_TIMESTAMP(mct.MODIFY_TIME), 'YYYYMMDDHH24MISS')  AS moiUpdateDate,
        CONCAT('${param.systemId}',CONCAT(';',CONCAT('${param.env}',CONCAT(';',CONCAT('数据字典',CONCAT(';',CONCAT('${param.importName}',CONCAT(';',CONCAT(lower(t.SCHEMA_NAME),CONCAT(';',lower(t.TABLE_NAME))))))))))) AS guid ,
        TO_VARCHAR (TO_TIMESTAMP(mct.MODIFY_TIME), 'YYYYMMDDHH24MISS')  AS updateTime
        FROM
        SYS.TABLES t LEFT JOIN sys.M_CS_TABLES mct
        ON (t.SCHEMA_NAME  = mct.SCHEMA_NAME  AND t.TABLE_NAME  = mct.TABLE_NAME )
        ) t2 ON lower(t.TABLE_NAME)  = t2.tableName AND lower(t.SCHEMA_NAME)  = t2.schemaName
        WHERE lower(t.SCHEMA_NAME) = '${param.schema}'
    </getTableToColumn>


    <getSchemasToSqlIndex type="RELATIONSHIP" workName="同步Schema->索引的关系" seq="10" label="resource.relational.schemaToSQLIndexEntity" srcLabel="resource.relational.schemaEntity" targetLabel="resource.relational.sQLIndexEntity">
        SELECT
            CONCAT('${param.systemId}',CONCAT(';',CONCAT('${param.env}',CONCAT(';',CONCAT('数据字典',CONCAT(';',CONCAT('${param.importName}',CONCAT(';',lower(v.SCHEMA_NAME))))))))) AS sourceGuid,
            CONCAT('${param.systemId}',CONCAT(';',CONCAT('${param.env}',CONCAT(';',CONCAT('数据字典',CONCAT(';',CONCAT('${param.importName}',CONCAT(';',CONCAT(lower(v.SCHEMA_NAME),CONCAT(';',concat(lower(v.INDEX_NAME),concat('_',lower(v.table_name))))))))))))) AS targetGuid
        FROM
        sys.INDEXES v
        where v.schema_name = '${param.schema}'
    </getSchemasToSqlIndex>

    <getSqlIndexToColumn type="RELATIONSHIP" workName="同步索引->字段的关系" seq="11" label="resource.relational.sQLIndexToColumnEntity" srcLabel="resource.relational.sQLIndexEntity" targetLabel="resource.relational.columnEntity">
        SELECT
            CONCAT('${param.systemId}',CONCAT(';',CONCAT('${param.env}',CONCAT(';',CONCAT('数据字典',CONCAT(';',CONCAT('${param.importName}',CONCAT(';',CONCAT(lower(v.SCHEMA_NAME),CONCAT(';',concat(lower(v.INDEX_NAME),concat('_',lower(v.table_name))))))))))))) AS sourceGuid,
            CONCAT('${param.systemId}',CONCAT(';',CONCAT('${param.env}',CONCAT(';',CONCAT('数据字典',CONCAT(';',CONCAT('${param.importName}',CONCAT(';',CONCAT(lower(v.SCHEMA_NAME),CONCAT(';',concat(lower(v.TABLE_NAME),concat(';',lower(v.COLUMN_NAME))))))))))))) AS targetGuid
        FROM sys.INDEX_COLUMNS v
            where lower(v.schema_name) = '${param.schema}'
    </getSqlIndexToColumn>

</sql>